---
- name: Install distributed etcd database.
  hosts: cluster
  become: yes

  tasks:  
  - name: Install needed packages.
    apt:
      name: openssl
      state: latest
  
  - name: Check for etcd and etcdctl install.
  ansible.builtin.stat:
    path:
      - /usr/local/bin/etcd
      - /usr/local/bin/etcdctl
  register: etcd
  
  - name: Create etcd directory.
    file:
      path: /home/{{ ansible_ssh_user }}/etcd-install-temp
      state: directory
    when: not etcd
  
  - name: Download and extract etcd binaries.
    unarchive:
      src: https://github.com/etcd-io/etcd/releases/download/{{ etcd_version }}/etcd-{{ etcd_version }}-linux-{{ node_arch }}.tar.gz
      dest: /home/{{ ansible_ssh_user }}/etcd-install-temp/
      remote_src: yes
    when: not etcd

  - name: Allow Architecture.
    lineinfile:
      path: /home/{{ ansible_ssh_user }}/.profile
      line: export ETCD_UNSUPPORTED_ARCH=arm64
    when:
      - not etcd
      - {{ node_arch }} == "arm64"

  - name: Allow Architecture for root.
    lineinfile:
      path: /etc/environment
      line: ETCD_UNSUPPORTED_ARCH=arm64
    when:
      - not etcd
      - {{ node_arch }} == "arm64"

  - name: Move etcd binary to '/usr/local/bin'.
    copy:
      src: /home/{{ ansible_ssh_user }}/etcd-install-temp/etcd-{{ etcd_version }}-linux-arm64/etcd
      dest: /usr/local/bin/etcd
      remote_src: yes
      mode: u+x,g+x,o+x
    when: not etcd
  
  - name: Move etcdctl binary to '/usr/local/bin'.
    copy:
      src: /home/{{ ansible_ssh_user }}/etcd-install-temp/etcd-{{ etcd_version }}-linux-arm64/etcdctl
      dest: /usr/local/bin/etcdctl
      remote_src: yes
      mode: u+x,g+x,o+x
    when: not etcd

  - name: Remove temp install directory.
    file:
      path: /home/{{ ansible_ssh_user }}/etcd-install-temp
      state: absent
    when: not etcd

  - name: Create etcd certificate directory.
    file:
      path: /home/{{ ansible_ssh_user }}/certs
      state: directory

  - name: Create certificate config file.
    file:
      path: /home/{{ ansible_ssh_user }}/certs/cert.json
      state: touch

  - name: Populate cert config file.
    lineinfile:
      path: /home/{{ ansible_ssh_user }}/certs/cert.json
      line: {"CN":"CA","key":{"algo":"rsa","size":2048}}

  - name: Create certs.
    command: 
      cmd: cfssl gencert -initca /home/{{ ansible_ssh_user }}/certs/cert.json | cfssljson -bare ca -
      chdir: /home/{{ ansible_ssh_user }}/certs/
      creates:
        - ca-key.pem
        - ca.pem
        - ca.csr


